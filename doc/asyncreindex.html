<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.8.1: http://docutils.sourceforge.net/" />
<title>SeSQL asynchronous reindexation</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7056 2011-06-17 10:50:48Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="sesql-asynchronous-reindexation">
<h1 class="title">SeSQL asynchronous reindexation</h1>

<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#overview" id="id1">1&nbsp;&nbsp;&nbsp;Overview</a></li>
<li><a class="reference internal" href="#usage" id="id2">2&nbsp;&nbsp;&nbsp;Usage</a></li>
<li><a class="reference internal" href="#limitations" id="id3">3&nbsp;&nbsp;&nbsp;Limitations</a></li>
<li><a class="reference internal" href="#advanced-information" id="id4">4&nbsp;&nbsp;&nbsp;Advanced information</a><ul class="auto-toc">
<li><a class="reference internal" href="#what-is-the-state-file" id="id5">4.1&nbsp;&nbsp;&nbsp;What is the state file ?</a></li>
<li><a class="reference internal" href="#what-is-the-drift" id="id6">4.2&nbsp;&nbsp;&nbsp;What is the drift ?</a></li>
<li><a class="reference internal" href="#how-do-you-evaluate-the-eta" id="id7">4.3&nbsp;&nbsp;&nbsp;How do you evaluate the ETA ?</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h1><a class="toc-backref" href="#id1">1&nbsp;&nbsp;&nbsp;Overview</a></h1>
<p>Sometimes, you need  to alter SeSQL configuration. You  want to change
the stopwords list  or stemming options.  You want to  add a new index
column. You want to change the way the tables are partitioned.</p>
<p>If  your base  is not  in production,  or if  it's small  and you  can
tolerate a  temporary downtime on  search features, you can  just drop
the SeSQL  table, do  a <tt class="docutils literal">syncdb</tt>, and  run <tt class="docutils literal">sesqlreindex</tt>.  But if
your base is big and you can't tolerate a downtime of several minutes,
even less of several hours, this is not a solution.</p>
<p>Since  version  0.14,  SeSQL  provides  a  command  to  perform  those
operations  in  a  non-intrusive   (well,  only  slightly  intrusive),
way. Nonetheless,  be careful to  read the documentation  fully before
attempting it, and we  strongly advise you to run it  in a test server
before doing it live.</p>
<p>The idea is that you'll  create a new <tt class="docutils literal">sesql_config</tt> file elsewhere,
using different table  names in it. Then you'll run  the script, which
will reindex, slowly (at a configurable rate) the content into the new
tables. And then, you'll switch the production code to the new config,
using the new tables.</p>
<p>If  you fulfill  all  the requirements  (see  limitations below),  The
script is devised to ease the operation as much as possible :</p>
<ol class="arabic simple">
<li>It can be interrupted, and will restart work where it was.</li>
</ol>
<p>2. It'll  handle the content  that was changed  or added while  it was
running.</p>
<p>3.   It  can  work  slowly  enough  to  not  significantly  lower  the
performances of the  production. But it's up to you  to tune the speed
parameters  depending of  the volume  of your  base and  the available
resources.</p>
</div>
<div class="section" id="usage">
<h1><a class="toc-backref" href="#id2">2&nbsp;&nbsp;&nbsp;Usage</a></h1>
<p>Here is the typical usage of the script :</p>
<ol class="arabic simple">
<li>Make a new <tt class="docutils literal">sesql_config</tt> file,  with your new indexing rules. Be
careful to use different table names in the <tt class="docutils literal">TYPE_MAP</tt>.</li>
<li>Run the script once, to index  the content into the new config. Use
a state file so  you can restart where it stopped  in case of crash
of manual interruption. This will be done with a command like :</li>
</ol>
<pre class="literal-block">
./manage.py sesqlasyncreindex \
--step=1000 --delay=5 \
--state=/path/to/statefile.pickle \
--config=/path/to/new/sesql_config.py \
--datefield=indexed_at
</pre>
<ol class="arabic simple" start="3">
<li>When the script is  finished, stop your <tt class="docutils literal">sesql_update</tt> daemon (if
any),  and your  application; switch  it to  the new  configuration
file, and restart them.</li>
<li>To handle the content that  may have been changed/added between the
end of  the script  and the  restart of  your application,  run the
script in reverse mode (with the <strong>same</strong> state file, but providing
it the old <tt class="docutils literal">sesql_config</tt> file) :</li>
</ol>
<pre class="literal-block">
./manage.py sesqlasyncreindex \
--step=1000 --delay=5 \
--state=/path/to/statefile.pickle \
--config=/path/to/old/sesql_config.py \
--datefield=indexed_at --reverse
</pre>
<p>A more detailed list of options can be found using <tt class="docutils literal"><span class="pre">--help</span></tt>.</p>
</div>
<div class="section" id="limitations">
<h1><a class="toc-backref" href="#id3">3&nbsp;&nbsp;&nbsp;Limitations</a></h1>
<p>In order to work smoothly, this script has several prerequisites :</p>
<ol class="arabic">
<li><p class="first">You need enough available disk space.</p>
</li>
<li><p class="first">You need a <tt class="docutils literal">DateTimeField</tt> index in your SeSQL model, if possible
an indexation date defined like :</p>
<pre class="literal-block">
DateTimeField('indexed_at', sql_default = 'NOW()')
</pre>
<p>If you use another date field, from your business logic, then there
is no warranty  that related content will be fully  indexed. A safe
workaround  is  to disable  the  <cite>sesql_update`</cite>  daemon while  the
script is running, if you can afford that.</p>
</li>
<li><p class="first">It'll  not handle content  that was  not indexed before  (mapped to
<tt class="docutils literal">None</tt>   in    the   configuration,    or   discarded    by   the
<tt class="docutils literal">SKIP_CONDITION</tt>), but should be indexed  now. To index them, use
the classical <tt class="docutils literal">sesqlreindex</tt> command.</p>
</li>
<li><p class="first">Since it uses dates to detect content to reindex, if the chunk size
is  too   small,  it  may   loop  endlessly  reindexing   the  same
contents. The chunk size should be  big enough to ensure that there
is never more items that have  the exactly same indexation date (to
the second) than  the chunk size. You can check  that with a manual
SQL command like :</p>
</li>
</ol>
<pre class="literal-block">
SELECT count(*), indexed_at
FROM sesql_index
GROUP BY indexed_at
ORDER BY count(*) DESC LIMIT 5;
</pre>
<ol class="arabic simple" start="5">
<li>If  your contents are changing  too fast, you may  need to increase
the indexation speed.</li>
<li>It'll not  handle suppression.  Rows there were  deleted during the
operation of  the script may be  still present in the  new database
after the operation.   If this is a problem to  you, you'll have to
manually fix  that (using SQL or  Python). In a further  version of
the SeSQL, this may be fixed.</li>
</ol>
</div>
<div class="section" id="advanced-information">
<h1><a class="toc-backref" href="#id4">4&nbsp;&nbsp;&nbsp;Advanced information</a></h1>
<div class="section" id="what-is-the-state-file">
<h2><a class="toc-backref" href="#id5">4.1&nbsp;&nbsp;&nbsp;What is the state file ?</a></h2>
<p>The state  file is  Python pickle  of internal  variables used  by the
script. It'll  allow the script to  restart near where it  was (at the
beginning of  the current chunk, to  be precise) if it  is interrupted
and restarted. If you  don't use a state file, you  can try to restart
by using a manual start date, but  the ETA will not be as precise, and
you've to be careful into providing the right start date.</p>
</div>
<div class="section" id="what-is-the-drift">
<h2><a class="toc-backref" href="#id6">4.2&nbsp;&nbsp;&nbsp;What is the drift ?</a></h2>
<p>While  the   script  will  index   rows,  your  application   will  be
alive. That's the  whole purpose of the thing. So  it'll change data -
some rows will be  updated, some will be added. So  they'll have to be
re-indexed.</p>
<p>Imagine  you have  1 000  000 of  rows.  Reindexing  them will  take a
while, like  10 hours. During  those 10 hours,  10 000 rows  have been
changed/added.  So  it needs  to  reindex  those.  It'll take  like  6
minutes. But  then, 100 new  rows have been changed/added.  Which will
need to be reindexed. And so on.</p>
<p>The <em>drift  rate</em> is the rate  at which new items  are modified/added,
compared to the rate at which the indexation is going. In the example,
the drift rate is 0.01 (the  script reindex rows 100 times faster than
they are added).</p>
<p>If the drift rate  is higher (or equal) than 1,  it'll never manage to
reindex the  content, new content is  added faster than the  script is
running.</p>
</div>
<div class="section" id="how-do-you-evaluate-the-eta">
<h2><a class="toc-backref" href="#id7">4.3&nbsp;&nbsp;&nbsp;How do you evaluate the ETA ?</a></h2>
<p>Using a crystal ball, tea leaves and the Large Hardon Collider, why ?</p>
<p>More seriously,  the ETA is estimated  by looking at the  time used to
index all previous  content, the remaining content,  and the estimated
drift rate.</p>
<p>It's of course an approximation, but here are the key points :</p>
<ol class="arabic simple">
<li>It doesn't  count the &quot;down time&quot;, when the  script was not running
(if you interrupt and re-run it,  with a state file). That may skew
the  drift rate,  for content  added/changed while  the script  was
running is counted in the drift rate.</li>
<li>Estimating  the  drift  rate requires  an  expensive  <tt class="docutils literal"><span class="pre">count(*)</span></tt>
select, so by default it's only performed once every ten chunks.</li>
<li>The  estimation doesn't tell  apart changed and added  items, while
they are indeed  different. The estimation will be  accurate if the
changes  are mostly  added  content and  changing  the most  recent
content, but  not much  accurate if the  changes are  evenly spread
over all the data.</li>
<li>The estimation  does compute the limit of the  series (well, it's a
geometric  series, so  the limit  is easy  to compute),  and should
consider all  the &quot;items changed  while indexing the  items changed
while indexing the items changed...&quot; up to infinity.</li>
</ol>
</div>
</div>
</div>
</body>
</html>
