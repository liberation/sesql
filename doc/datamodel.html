<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.8.1: http://docutils.sourceforge.net/" />
<title>SeSQL data model guide</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7056 2011-06-17 10:50:48Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="sesql-data-model-guide">
<h1 class="title">SeSQL data model guide</h1>

<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#general" id="id1">1&nbsp;&nbsp;&nbsp;General</a></li>
<li><a class="reference internal" href="#concepts" id="id2">2&nbsp;&nbsp;&nbsp;Concepts</a></li>
<li><a class="reference internal" href="#fields" id="id3">3&nbsp;&nbsp;&nbsp;Fields</a></li>
<li><a class="reference internal" href="#mandatory-fields" id="id4">4&nbsp;&nbsp;&nbsp;Mandatory fields</a></li>
<li><a class="reference internal" href="#sources" id="id5">5&nbsp;&nbsp;&nbsp;Sources</a></li>
<li><a class="reference internal" href="#easy-writing-of-sources" id="id6">6&nbsp;&nbsp;&nbsp;Easy writing of sources</a></li>
<li><a class="reference internal" href="#type-map" id="id7">7&nbsp;&nbsp;&nbsp;Type map</a></li>
<li><a class="reference internal" href="#dependency-tracking" id="id8">8&nbsp;&nbsp;&nbsp;Dependency tracking</a></li>
<li><a class="reference internal" href="#cleanup-in-text-fields" id="id9">9&nbsp;&nbsp;&nbsp;Cleanup in text fields</a></li>
<li><a class="reference internal" href="#additional-text-search-configurations" id="id10">10&nbsp;&nbsp;&nbsp;Additional text search configurations</a></li>
</ul>
</div>
<div class="section" id="general">
<h1><a class="toc-backref" href="#id1">1&nbsp;&nbsp;&nbsp;General</a></h1>
<p>SeSQL data model is described in a 'sesql_config.py' file in the project.</p>
<p>It should define three variables :</p>
<dl class="docutils">
<dt>FIELDS</dt>
<dd>A list (or tuple) of fields.</dd>
<dt>MASTER_TABLE_NAME</dt>
<dd>The name of the master table to use.</dd>
<dt>TYPE_MAP</dt>
<dd>Association between Django types and tables.</dd>
</dl>
</div>
<div class="section" id="concepts">
<h1><a class="toc-backref" href="#id2">2&nbsp;&nbsp;&nbsp;Concepts</a></h1>
<p>SeSQL  data model is  composed of  <em>fields</em>. A  field is  something on
which you  can perform queries and  order the data, it's  similar to a
Django field.</p>
<p>Fields are computed from <em>sources</em>.  A source will fetch the values to
compose a  field, taking  object attributes, concatenating  several of
them, calling methods, or following relations.</p>
</div>
<div class="section" id="fields">
<h1><a class="toc-backref" href="#id3">3&nbsp;&nbsp;&nbsp;Fields</a></h1>
<p>Each  field has  a  type, a  name, a  source  and may  have some  type
dependant options.</p>
<p>Known types are :</p>
<dl class="docutils">
<dt>IntField</dt>
<dd>Normal integer field.</dd>
<dt>StrField</dt>
<dd>Normal string field, up to 255 characters wide,``size`` can be specified.</dd>
<dt>ClassField</dt>
<dd>Handle the  class of the  object. This  is a mandatory  field.
Since    version   0.12    it   accepts    an   optional    argument
<tt class="docutils literal">dereference_proxy</tt>  which will  make SeSQL  index Django's  proxy
models  if they  were the  underlying class.  This only  affects the
class name,  the various methods will  still be called on  the proxy
model.</dd>
<dt>DateField</dt>
<dd>Date field, without time.</dd>
<dt>DateTimeField</dt>
<dd>Date field, with time.</dd>
<dt>IntArrayField</dt>
<dd>Field storing multi-valued integers.</dd>
<dt>FullTextField</dt>
<dd>The beast  for which SeSQL was  designed, a full-text index,  can be
made <tt class="docutils literal">primary</tt> to be used in rankings.
You  can specify  a  different text  search  configuration than  the
default on a given FullTextField with the <tt class="docutils literal">dictionnary</tt> parameter.</dd>
</dl>
</div>
<div class="section" id="mandatory-fields">
<h1><a class="toc-backref" href="#id4">4&nbsp;&nbsp;&nbsp;Mandatory fields</a></h1>
<p>In current SeSQL version, it is mandatory to have at least :</p>
<ul class="simple">
<li>a <tt class="docutils literal">ClassField</tt> named <tt class="docutils literal">classname</tt> ;</li>
<li>an <tt class="docutils literal">IntField</tt> named <tt class="docutils literal">id</tt> that is unique for a given <tt class="docutils literal">classname</tt>.</li>
</ul>
<p>It is  also strongly  recommended to  have <tt class="docutils literal">DateTimeField</tt>  with the
date of indexation, defined like :</p>
<pre class="literal-block">
DateTimeField('indexed_at', sql_default = 'NOW()')
</pre>
</div>
<div class="section" id="sources">
<h1><a class="toc-backref" href="#id5">5&nbsp;&nbsp;&nbsp;Sources</a></h1>
<p>Each field requires a 'source'. The source can be one of the following
classes :</p>
<dl class="docutils">
<dt>SimpleField</dt>
<dd>Will just fetch  an attribute from the Django object,  can specify a
condition (Q object) to filter on.</dd>
<dt>MethodCaller</dt>
<dd>Will call a method from the Django object.</dd>
<dt>SubField</dt>
<dd>Will  walk accross  one or  several many-to-many  mappings, fetching
attributes of the related objects.</dd>
<dt>TextAggregate</dt>
<dd>Concatenate the result of other sources.</dd>
<dt>WeightedAggregate</dt>
<dd>Allow  to ponder  the result  of  different sources  for ranking  by
relevance. Weights  can go from A  (highest) to D (lowest).  Look at
PosgreSQL documentation for more information on weights.</dd>
<dt>FirstOf</dt>
<dd>Gets the first non-None value of a list of other sources (useful for
example to track the creation date which is called <tt class="docutils literal">created_at</tt> on
some models and <tt class="docutils literal">created_on</tt> on others).</dd>
</dl>
</div>
<div class="section" id="easy-writing-of-sources">
<h1><a class="toc-backref" href="#id6">6&nbsp;&nbsp;&nbsp;Easy writing of sources</a></h1>
<p>Source can also be given in a more friendly way :</p>
<ul class="simple">
<li>as a normal string for a <tt class="docutils literal">SimpleField</tt> (ie, <tt class="docutils literal">workflow_state</tt>) ;</li>
<li>as a normal string terminated with <tt class="docutils literal">()</tt> for a <tt class="docutils literal">MethodCaller</tt>
(ie, <tt class="docutils literal"><span class="pre">&quot;getFullName()&quot;</span></tt>) ;</li>
<li>as a path separated by <tt class="docutils literal">.</tt> for a <tt class="docutils literal">SubField</tt> (ie, <tt class="docutils literal">&quot;.authors.firstname&quot;</tt>) ;</li>
<li>as a list or tuple for a <tt class="docutils literal">TextAggregate</tt> (ie <tt class="docutils literal">( &quot;firstname&quot;, &quot;lastname&quot; )</tt>) ;</li>
<li>a dictionary for a <tt class="docutils literal">WeightedAggregate</tt> (ie <tt class="docutils literal">{ 'A': (&quot;firstname&quot;, <span class="pre">&quot;lastname&quot;),</span> 'B': <span class="pre">(&quot;nickname&quot;,)</span> }</tt>).</li>
</ul>
<p>If the source is not specified, it'll be a <tt class="docutils literal">SimpleField</tt> of the same
name that the index.</p>
</div>
<div class="section" id="type-map">
<h1><a class="toc-backref" href="#id7">7&nbsp;&nbsp;&nbsp;Type map</a></h1>
<p>The  type  map   is  a  list  (or  tuple)   of  <tt class="docutils literal">(class,&nbsp; table_name,
recursive)</tt>. All  Django objects of  this class will be  indexed into
the given table.  All objects of a subclass  too, unless the recursive
parameter is set to False (it defaults to True).</p>
<p>If the same  class is reachable twice (due  to multiple inheritance or
to specifying  both a  base class  and a derivative  in the  map), the
first entry that matches is taken.</p>
<p>You specify  None as  the table to  explicitly ban indexing  a content
type even if a base class has to be indexed.</p>
<p>Example</p>
<pre class="literal-block">
TYPE_MAP = ((models.Photo, &quot;sesql_photo&quot;, False),
            (models.Comment, &quot;sesql_comment&quot;),
            (models.BaseModel, &quot;sesql_default&quot;))
</pre>
</div>
<div class="section" id="dependency-tracking">
<h1><a class="toc-backref" href="#id8">8&nbsp;&nbsp;&nbsp;Dependency tracking</a></h1>
<p>SeSQL provides  semi-automatic dependency tracking. This  works in two
steps.</p>
<p>1. By implementing  a method <tt class="docutils literal">get_related_objects_for_indexation</tt> on
your models, which  must return a lit of (classname,  id) pairs (or of
Django  objects).  This  method  will  be called  when  an  object  is
indexed. All  &quot;related objects&quot; will  then be inserted into  a special
table, called <tt class="docutils literal">sesql_reindex_schedule</tt>.</p>
<p>2. Then, asynchronously, a daemon will fetch rows from this table, and
reindex objects.</p>
</div>
<div class="section" id="cleanup-in-text-fields">
<h1><a class="toc-backref" href="#id9">9&nbsp;&nbsp;&nbsp;Cleanup in text fields</a></h1>
<p>Before indexing text  fields, cleanup has to be  performed.  In SeSQL,
the cleanup is a two-phase process.</p>
<p>The first phase is user-configurable. It  should strip the text of all
meta-information (HTML tags, wiki syntax, ...) and gives plain text.</p>
<p>The second phase  is automatic, it consists in  stripping all accents,
converting  upper-case letters  to  lower-case  letters and  replacing
special characters with spaces.</p>
<p>To configure the first phase, you have two options :</p>
<p>1.  Specify the  <tt class="docutils literal">ADDITIONAL_CLEANUP_FUNCTION</tt> in  the configuration
file.  This  should  contain  a  function, which  takes  the  text  as
parameter and returns the cleaned up text.</p>
<p>2.  Add  a <tt class="docutils literal">cleanup</tt>  parameter  to  the <tt class="docutils literal">FullTextField</tt>,  with  a
similar function.</p>
<p>The  <tt class="docutils literal">ADDITIONAL_CLEANUP_FUNCTION</tt>   will  be   used  only   if  the
<tt class="docutils literal">cleanup</tt> parameter was not specified, or set to None.</p>
</div>
<div class="section" id="additional-text-search-configurations">
<h1><a class="toc-backref" href="#id10">10&nbsp;&nbsp;&nbsp;Additional text search configurations</a></h1>
<p>If you want  additional text search configurations to  be created when
SeSQL  tables   are  created,  you  can   add  the  SQL  lines   in  a
ADDITIONAL_TS_CONFIG variable  in the config file.  Refer to PosgreSQL
documentation for more details.</p>
</div>
</div>
</body>
</html>
